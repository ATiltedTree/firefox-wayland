From 0825c9106999c863324477fb1bb43ca9b1d5b48b Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Thu, 18 Nov 2021 15:47:23 +0100
Subject: [PATCH 13/22] enable OOP Compositing regardless of X11

---
 widget/CompositorWidget.h |  2 +-
 widget/gtk/moz.build      | 18 ++++++++----------
 widget/moz.build          |  2 +-
 3 files changed, 10 insertions(+), 12 deletions(-)

diff --git a/widget/CompositorWidget.h b/widget/CompositorWidget.h
index 4515f4ccc0597..b93e1860a9fcd 100644
--- a/widget/CompositorWidget.h
+++ b/widget/CompositorWidget.h
@@ -63,7 +63,7 @@ class CompositorWidgetDelegate {
 };
 
 // Platforms that support out-of-process widgets.
-#if defined(XP_WIN) || defined(MOZ_X11)
+#if defined(XP_WIN) || defined(MOZ_WIDGET_GTK)
 // CompositorWidgetParent should implement CompositorWidget and
 // PCompositorWidgetParent.
 class CompositorWidgetParent;
diff --git a/widget/gtk/moz.build b/widget/gtk/moz.build
index 91a98cd71017e..2e3fb6ae61503 100644
--- a/widget/gtk/moz.build
+++ b/widget/gtk/moz.build
@@ -33,15 +33,22 @@ EXPORTS += [
 EXPORTS.mozilla += ["WidgetUtilsGtk.h"]
 
 EXPORTS.mozilla.widget += [
+    "CompositorWidgetChild.h",
+    "CompositorWidgetParent.h",
+    "GtkCompositorWidget.h",
+    "InProcessGtkCompositorWidget.h",
     "WindowSurface.h",
     "WindowSurfaceProvider.h",
 ]
 
 UNIFIED_SOURCES += [
+    "CompositorWidgetChild.cpp",
+    "CompositorWidgetParent.cpp",
     "GfxInfo.cpp",
     "gtk3drawing.cpp",
     "GtkCompositorWidget.cpp",
     "IMContextWrapper.cpp",
+    "InProcessGtkCompositorWidget.cpp",
     "keysym2ucs.c",
     "MozContainer.cpp",
     "MPRISServiceHandler.cpp",
@@ -59,6 +66,7 @@ UNIFIED_SOURCES += [
     "nsNativeBasicThemeGTK.cpp",
     "nsSound.cpp",
     "nsToolkit.cpp",
+    "nsUserIdleServiceGTK.cpp",
     "nsWidgetFactory.cpp",
     "ScreenHelperGTK.cpp",
     "TaskbarProgress.cpp",
@@ -102,23 +110,13 @@ if CONFIG["MOZ_WAYLAND"]:
 
 if CONFIG["MOZ_X11"]:
     UNIFIED_SOURCES += [
-        "CompositorWidgetChild.cpp",
-        "CompositorWidgetParent.cpp",
-        "InProcessGtkCompositorWidget.cpp",
         "nsClipboardX11.cpp",
         "nsShmImage.cpp",
-        "nsUserIdleServiceGTK.cpp",
         "WindowSurfaceX11.cpp",
         "WindowSurfaceX11Image.cpp",
         "WindowSurfaceX11SHM.cpp",
         "WindowSurfaceXRender.cpp",
     ]
-    EXPORTS.mozilla.widget += [
-        "CompositorWidgetChild.h",
-        "CompositorWidgetParent.h",
-        "GtkCompositorWidget.h",
-        "InProcessGtkCompositorWidget.h",
-    ]
 
 if CONFIG["NS_PRINTING"]:
     UNIFIED_SOURCES += [
diff --git a/widget/moz.build b/widget/moz.build
index 5a0ec16340e12..d56feb53285dc 100644
--- a/widget/moz.build
+++ b/widget/moz.build
@@ -302,7 +302,7 @@ if toolkit == "windows":
         "windows/PCompositorWidget.ipdl",
         "windows/PlatformWidgetTypes.ipdlh",
     ]
-elif CONFIG["MOZ_WIDGET_TOOLKIT"] == "gtk" and CONFIG["MOZ_X11"]:
+elif CONFIG["MOZ_WIDGET_TOOLKIT"] == "gtk":
     IPDL_SOURCES = [
         "gtk/PCompositorWidget.ipdl",
         "gtk/PlatformWidgetTypes.ipdlh",
-- 
2.35.1

