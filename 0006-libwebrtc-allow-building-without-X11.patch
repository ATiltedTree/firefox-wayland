From 35c13879cbaec906bd67180b0d9018d4192932c2 Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Thu, 18 Nov 2021 15:42:49 +0100
Subject: [PATCH 06/19] libwebrtc: allow building without X11

---
 .../desktop_capture_generic_gn/moz.build      | 37 ++++++++-----------
 .../desktop_capture_gn/moz.build              | 11 ------
 .../desktop_capture/desktop_capturer.cc       |  1 -
 .../libwebrtc/webrtc/webrtc_gn/moz.build      | 25 +++++++------
 4 files changed, 29 insertions(+), 45 deletions(-)

diff --git a/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_generic_gn/moz.build b/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_generic_gn/moz.build
index 16b0f5d09ef83..4386d75cf78c8 100644
--- a/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_generic_gn/moz.build
+++ b/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_generic_gn/moz.build
@@ -160,41 +160,34 @@ if CONFIG["OS_TARGET"] == "FreeBSD":
 if CONFIG["OS_TARGET"] == "Linux":
 
     DEFINES["USE_NSS_CERTS"] = "1"
-    DEFINES["USE_X11"] = "1"
     DEFINES["WEBRTC_LINUX"] = True
     DEFINES["WEBRTC_POSIX"] = True
     DEFINES["_FILE_OFFSET_BITS"] = "64"
 
     OS_LIBS += [
         "rt",
-        "X11",
-        "X11-xcb",
-        "xcb",
-        "Xcomposite",
-        "Xcursor",
-        "Xdamage",
-        "Xext",
-        "Xfixes",
-        "Xi",
-        "Xrender"
     ]
 
     UNIFIED_SOURCES += [
         "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/desktop_device_info_x11.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/mouse_cursor_monitor_x11.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/screen_capturer_x11.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/shared_x_display.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/shared_x_util.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/window_capturer_x11.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/window_finder_x11.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/window_list_utils.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/x_atom_cache.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/x_error_trap.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/x_server_pixel_buffer.cc",
         "/third_party/libwebrtc/webrtc/modules/desktop_capture/mouse_cursor_monitor_linux.cc",
         "/third_party/libwebrtc/webrtc/modules/desktop_capture/screen_capturer_linux.cc",
-        "/third_party/libwebrtc/webrtc/modules/desktop_capture/window_capturer_linux.cc"
+        "/third_party/libwebrtc/webrtc/modules/desktop_capture/window_capturer_linux.cc",
     ]
+ 
+    if CONFIG["MOZ_X11"]:
+        UNIFIED_SOURCES += [
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/mouse_cursor_monitor_x11.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/screen_capturer_x11.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/shared_x_display.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/window_capturer_x11.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/window_finder_x11.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/window_list_utils.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/x_atom_cache.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/x_error_trap.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/x_server_pixel_buffer.cc",
+            "/third_party/libwebrtc/webrtc/modules/desktop_capture/linux/x_window_property.cc",
+        ]
 
 if CONFIG["OS_TARGET"] == "NetBSD":
 
diff --git a/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_gn/moz.build b/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_gn/moz.build
index e8e23698551b1..5a5d7a2aa66f4 100644
--- a/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_gn/moz.build
+++ b/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capture_gn/moz.build
@@ -95,23 +95,12 @@ if CONFIG["OS_TARGET"] == "FreeBSD":
 if CONFIG["OS_TARGET"] == "Linux":
 
     DEFINES["USE_NSS_CERTS"] = "1"
-    DEFINES["USE_X11"] = "1"
     DEFINES["WEBRTC_LINUX"] = True
     DEFINES["WEBRTC_POSIX"] = True
     DEFINES["_FILE_OFFSET_BITS"] = "64"
 
     OS_LIBS += [
         "rt",
-        "X11",
-        "X11-xcb",
-        "xcb",
-        "Xcomposite",
-        "Xcursor",
-        "Xdamage",
-        "Xext",
-        "Xfixes",
-        "Xi",
-        "Xrender"
     ]
 
 if CONFIG["OS_TARGET"] == "NetBSD":
diff --git a/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capturer.cc b/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capturer.cc
index 5e4dcb058d166..87ea0a95b61b8 100644
--- a/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capturer.cc
+++ b/third_party/libwebrtc/webrtc/modules/desktop_capture/desktop_capturer.cc
@@ -15,7 +15,6 @@
 
 #if defined(WEBRTC_USE_PIPEWIRE) || defined(USE_X11)
 #include <gtk/gtk.h>
-#include <gtk/gtkx.h>
 #endif
 
 namespace webrtc {
diff --git a/third_party/libwebrtc/webrtc/webrtc_gn/moz.build b/third_party/libwebrtc/webrtc/webrtc_gn/moz.build
index 7ce0675b163b2..05a49448b1f6b 100644
--- a/third_party/libwebrtc/webrtc/webrtc_gn/moz.build
+++ b/third_party/libwebrtc/webrtc/webrtc_gn/moz.build
@@ -129,24 +129,27 @@ if CONFIG["OS_TARGET"] == "FreeBSD":
 if CONFIG["OS_TARGET"] == "Linux":
 
     DEFINES["USE_NSS_CERTS"] = "1"
-    DEFINES["USE_X11"] = "1"
     DEFINES["WEBRTC_LINUX"] = True
     DEFINES["WEBRTC_POSIX"] = True
     DEFINES["_FILE_OFFSET_BITS"] = "64"
 
+    if CONFIG["MOZ_X11"]:
+        DEFINES["USE_X11"] = "1"
+        DEFINES["WEBRTC_USE_X11"] = True
+        OS_LIBS += [
+            "X11",
+            "Xcomposite",
+            "Xdamage",
+            "Xext",
+            "Xfixes",
+            "Xrandr",
+            "Xrender",
+            "Xtst"
+        ]
+
     OS_LIBS += [
         "m",
         "rt",
-        "X11",
-        "X11-xcb",
-        "xcb",
-        "Xcomposite",
-        "Xcursor",
-        "Xdamage",
-        "Xext",
-        "Xfixes",
-        "Xi",
-        "Xrender"
     ]
 
 if CONFIG["OS_TARGET"] == "NetBSD":
-- 
2.34.0

