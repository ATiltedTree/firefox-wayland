From 5dd7b663b44f55db3080b018f43a722b28f9f1ee Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Thu, 18 Nov 2021 19:31:01 +0100
Subject: [PATCH 20/20] allow turning on/off of X11 and wayland

---
 old-configure.in                 |  2 +-
 python/mozboot/mozboot/gentoo.py |  1 -
 toolkit/moz.configure            | 47 ++++++++++++++++++++------------
 3 files changed, 31 insertions(+), 19 deletions(-)

diff --git a/old-configure.in b/old-configure.in
index 647d20739497a..e71395051058c 100644
--- a/old-configure.in
+++ b/old-configure.in
@@ -2719,7 +2719,7 @@ if test -n "$COMPILE_ENVIRONMENT"; then
 AC_CHECK_FUNCS(posix_fadvise posix_fallocate)
 
 dnl Check for missing components
-if test "$MOZ_X11"; then
+if test -n "$MOZ_X11"; then
     dnl ====================================================
     dnl = Check if X headers exist
     dnl ====================================================
diff --git a/python/mozboot/mozboot/gentoo.py b/python/mozboot/mozboot/gentoo.py
index a61581593f5e6..d0211db329992 100644
--- a/python/mozboot/mozboot/gentoo.py
+++ b/python/mozboot/mozboot/gentoo.py
@@ -52,7 +52,6 @@ class GentooBootstrapper(LinuxBootstrapper, BaseBootstrapper):
                 "dev-libs/dbus-glib",
                 "media-sound/pulseaudio",
                 "x11-libs/gtk+:3",
-                "x11-libs/libXt",
             ]
         )
 
diff --git a/toolkit/moz.configure b/toolkit/moz.configure
index 096ffcdade5e2..340a954880e5a 100644
--- a/toolkit/moz.configure
+++ b/toolkit/moz.configure
@@ -265,7 +265,7 @@ def toolkit_choices(target):
     elif target.os == "Android":
         return ("cairo-android",)
     else:
-        return ("cairo-gtk3", "cairo-gtk3-wayland")
+        return ("cairo-gtk3",)
 
 
 @depends(toolkit_choices)
@@ -313,30 +313,43 @@ set_define(toolkit_define, True)
 def toolkit_gtk(toolkit):
     return toolkit == "gtk"
 
+# X11
+# ============================================================
+option(
+    "--with-x",
+    help="{Enable X11 support|Disable X11 support}",
+)
+
+@depends("--with-x", toolkit_gtk)
+def with_x(value, toolkit_gtk):
+    if value and toolkit_gtk:
+        return True
 
-set_config("MOZ_X11", True, when=toolkit_gtk)
-set_define("MOZ_X11", True, when=toolkit_gtk)
-add_old_configure_assignment("MOZ_X11", True, when=toolkit_gtk)
+
+set_config("MOZ_X11", True, when=with_x)
+set_define("MOZ_X11", True, when=with_x)
+add_old_configure_assignment("MOZ_X11", True, when=with_x)
 
 # Wayland support
 # ==============================================================
-wayland_headers = pkg_check_modules(
-    "MOZ_WAYLAND",
-    "gtk+-wayland-3.0 >= 3.14 xkbcommon >= 0.4.1 libdrm >= 2.4",
-    allow_missing=depends(full_toolkit)(lambda t: t == "cairo-gtk3"),
-    when=depends(full_toolkit)(lambda t: t in ("cairo-gtk3", "cairo-gtk3-wayland")),
+option(
+    "--with-wayland",
+    help="{Enable wayland support|Disable wayland support}",
 )
 
-
-@depends(wayland_headers, toolkit_gtk, artifact_builds)
-def wayland_headers(wayland, toolkit_gtk, artifacts):
-    if toolkit_gtk and artifacts:
+@depends("--with-wayland", toolkit_gtk, artifact_builds)
+def with_wayland(value, toolkit_gtk, artifacts):
+    if value and toolkit_gtk or artifacts:
         return True
-    return wayland
 
+wayland_headers = pkg_check_modules(
+    "MOZ_WAYLAND",
+    "gtk+-wayland-3.0 >= 3.14 xkbcommon >= 0.4.1 libdrm >= 2.4",
+    when=with_wayland,
+)
 
-set_config("MOZ_WAYLAND", depends_if(wayland_headers)(lambda _: True))
-set_define("MOZ_WAYLAND", depends_if(wayland_headers)(lambda _: True))
+set_config("MOZ_WAYLAND", True, when=with_wayland)
+set_define("MOZ_WAYLAND", True, when=with_wayland)
 
 # GL Provider
 # ==============================================================
@@ -358,7 +371,7 @@ def gl_provider_define(provider):
 set_define("MOZ_GL_PROVIDER", gl_provider_define)
 
 
-@depends(gl_provider, wayland_headers, toolkit_gtk)
+@depends(gl_provider, with_wayland, toolkit_gtk)
 def gl_default_provider(value, wayland, toolkit_gtk):
     if value:
         return value
-- 
2.35.1

