From ee87b28db36ea4b9f4e6817671efa56b235ae31a Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Fri, 19 Nov 2021 15:06:58 +0100
Subject: [PATCH 18/23] make sure xul links with mozgtk

---
 widget/gtk/mozgtk/mozgtk.c | 6 +++++-
 widget/gtk/nsWindow.cpp    | 6 ++++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/widget/gtk/mozgtk/mozgtk.c b/widget/gtk/mozgtk/mozgtk.c
index 677f9b356160a..75c6f71832f97 100644
--- a/widget/gtk/mozgtk/mozgtk.c
+++ b/widget/gtk/mozgtk/mozgtk.c
@@ -6,7 +6,10 @@
 
 #include "mozilla/Types.h"
 
-#include <X11/Xlib.h>
+MOZ_EXPORT void PleaseLinkWithMe() {}
+
+#ifdef MOZ_X11
+#  include <X11/Xlib.h>
 // Bug 1271100
 // We need to trick system Cairo into not using the XShm extension due to
 // a race condition in it that results in frequent BadAccess errors. Cairo
@@ -19,3 +22,4 @@
 // ever can remove this workaround for system Cairo, we'll need something
 // to replace it for that purpose.
 MOZ_EXPORT Bool XShmQueryExtension(Display* aDisplay) { return False; }
+#endif
diff --git a/widget/gtk/nsWindow.cpp b/widget/gtk/nsWindow.cpp
index 1af1e37c73a36..53ccaa220ea8f 100644
--- a/widget/gtk/nsWindow.cpp
+++ b/widget/gtk/nsWindow.cpp
@@ -120,6 +120,11 @@ using namespace mozilla::gfx;
 using namespace mozilla::layers;
 using namespace mozilla::widget;
 
+extern "C" {
+// Make sure mozgtk gets linked
+MOZ_EXPORT void PleaseLinkWithMe();
+}
+
 // Don't put more than this many rects in the dirty region, just fluff
 // out to the bounding-box if there are more
 #define MAX_RECTS_IN_REGION 100
@@ -500,6 +505,7 @@ nsWindow::nsWindow()
       mRelativePointer(nullptr)
 #endif
 {
+  PleaseLinkWithMe();
   mWindowType = eWindowType_child;
   mSizeConstraints.mMaxSize = GetSafeWindowSize(mSizeConstraints.mMaxSize);
 
-- 
2.34.1

